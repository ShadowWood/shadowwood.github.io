<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!--Description-->
    
        <meta name="description" content="在web端实现简单的按钮计时，防止用户短时间内重复的操作">
    

    <!--Author-->
    
        <meta name="author" content="Shadow Wood">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="javascript实现按钮计时"/>
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="ShadowWood&#39;s Blog"/>

    <!--Page Cover-->
    
        <meta property="og:image" content="undefined"/>
    

    <!-- Title -->
    
    <title>javascript实现按钮计时 - ShadowWood&#39;s Blog</title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/sass/main.css">

    <!--[if lt IE 8]>
        <script src="/js/ie/html5shiv.js"></script>
    <![endif]-->

    <!--[if lt IE 8]>
        <link rel="stylesheet" href="/sass/ie8.css">
    <![endif]-->

    <!--[if lt IE 9]>
        <link rel="stylesheet" href="/sass/ie9.css">
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdn.rawgit.com/noelboss/featherlight/1.3.5/release/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    


</head>

<body>

    <div id="wrapper">

        <!-- Menu -->
        <!-- Header -->
<header id="header">
    <div class="inner">

        <!-- Logo -->
        <a href="/" class="logo">
            <span class="symbol"><img src="/images/glasses.svg" alt="" /></span><span class="title">ShadowWood's Blog</span>
        </a>

        <!-- Nav -->
        <nav>
            <ul>
                <li><a href="#menu">Menu</a></li>
            </ul>
        </nav>

    </div>
</header>

<!-- Menu -->
<nav id="menu">
    <h2>Menu</h2>
    <ul>
        
            <li>
                <a href="/">Home</a>
            </li>
        
            <li>
                <a href="/archives">Archives</a>
            </li>
        
            <li>
                <a href="/tags">Tags</a>
            </li>
        
            <li>
                <a href="/categories">Categories</a>
            </li>
        
            <li>
                <a href="/about">About</a>
            </li>
        
    </ul>
</nav>


        <div id="main">
            <div class="inner">

                <!-- Main Content -->
                

    <h1 class="title">javascript实现按钮计时</h1>
    <div class="meta">
        2015-04-18
    </div>


<!-- Tags -->



<div class="tags">
    <a href="/tags/javascript/" class="button small">javascript</a>
</div>




    <span class="image main"><img src="http://7xu027.com1.z0.glb.clouddn.com/button-timer.jpg" alt="" /></span>


<!-- Gallery -->


<!-- Content -->
<p>最近实验和项目忙得不可开交，终于可以闲下心来写写博客了。</p>
<p>这段时间都在做后台管理的web端，自然也离不开短信验证那一套东西，最开始对js不熟，做按钮计时花了大半时间。<br>今天就拿这个下手吧。为了方便操作html中的元素，就直接用jquery框架了。<br><a id="more"></a></p>
<p>首先先确定需要输入的东西，一个是手机号，一个是验证码。</p>
<pre><code>&lt;script src=&quot;http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js&quot;&gt;&lt;/script&gt;
&lt;label&gt;手机号：&lt;/label&gt;
&lt;input id=&quot;phone&quot;&gt;
&lt;br/&gt;
&lt;label&gt;验证码：&lt;/label&gt;
&lt;input&gt;
&lt;button id=&quot;get_verify_code&quot;&gt;获取验证码&lt;/button&gt;
</code></pre><p> 首先我们得实现在用户点击意义“获取验证码”按钮后，得有一个计时机制，防止用户在短时间内多次获取验证码，而且同时也有暗示用户获取验证码这步操作已经执行。计时的功能用setInterval()函数来实现。先贴出代码：</p>
<pre><code>&lt;script type=&quot;text/javascript&quot;&gt;
    var count;
    var countdown;
    var button = $(&apos;#get_verify_code&apos;)
    function Count(){
        count--;
        button.text(&quot;请等待&quot;+count+&quot;秒&quot;);
        if(count == 0){
            clearInterval(countdown);
            button.text(&quot;获取验证码&quot;);
            button.removeAttr(&apos;disabled&apos;);
        }
    }
    button.click(function(){
        count = 30;
        $(this).text(&quot;请等待&quot;+count+&quot;秒&quot;);
        $(this).attr(&apos;disabled&apos;, true);
        countdown = setInterval(Count, 1000);
    })
&lt;/script&gt;
</code></pre><p>OK，这段代码的两个重点就是setIntercval()函数和全局变量的使用。首先我们来了解下setInterval()函数。</p>
<p>函数定义：</p>
<ul>
<li>setInterval() 方法可按照指定的周期（以毫秒计）来调用函数或计算表达式。</li>
<li>setInterval() 方法会不停地调用函数，直到 clearInterval() 被调用或窗口被关闭。由 setInterval() 返回的 ID 值可用作 clearInterval() 方法的参数。</li>
</ul>
<p>函数语法：</p>
<ul>
<li>setInterval(code,millisec[,”lang”])</li>
</ul>
<p>参数：</p>
<ul>
<li>code必须。要调用的函数或要执行的代码串。</li>
<li>millisec必须。周期性执行或调用 code 之间的时间间隔，以毫秒计。</li>
</ul>
<p>返回值:</p>
<ul>
<li>一个可以传递给 Window.clearInterval( ) 从而取消对 code 的周期性执行的值。</li>
</ul>
<p>我们将计时函数 Count( )  用 setInterval( ) 函数来不断执行，知道计时标志 count &lt;= 0 时，停止计时，将按钮恢复如初。在代码中我用了setInterval(Count, 1000), 其中 Count 时 Count( )函数的函数名，“1000”是指定的周期，即1000毫秒＝1秒。</p>
<p>至于为什么我要将 count 和 countdown 定义为全局变量，以下便是我的理由：</p>
<ul>
<li><p>count 作为计时标志，每次都会被函数 Count( ) 调用操作，故应将其定义为全局变量避免出现错误。</p>
</li>
<li><p>countdown 是 setInterval( ) 返回的 id 值，用来作为 clearInterval( ) 的参数停止计时，而在这里clearInterval( ) 被用在 Count( ) 之中，而 Count( ) 又是在 setInterval( ) 里被调用，为了使countdown有效，其必须定义在 setInterval( ) 之外，故将其定义为全局变量。</p>
</li>
</ul>
<p>这样一看其实还挺明显的，但是之后等我们加入下一个功能，你就会明白全局变量的重要性了。</p>
<hr>
<p>相信大家已经发现这个按钮计时有个明显的缺陷了，那就是只要你将当前的页面一刷新，按钮又可以使用了，那么做的这一切就没用了。</p>
<p>要解决这个问题有两种方案：</p>
<ul>
<li>在后台存储用户点击按钮时的时间，每次用户向后台发出页面请求的时候，判定当前的时间距离上一次点击按钮的时间相差是否有30秒，然后进行对应的操作；</li>
<li>在本地存储用户点击按钮时的时间，用法同上。</li>
</ul>
<p>这里我们为了减少向服务器请求的数据（我不会告诉你其实是我想偷懒！＝。＝），便采用第二种方案。</p>
<p>本地存储的方式有两种，一是使用 localStorage, 二是使用 sessionStorage。前者是永久存储，后者如果关闭浏览器就清空。这里我们用 localStorage。 ok，想法就这样，先贴出代码：</p>
<pre><code>&lt;script type=&quot;text/javascript&quot;&gt;
    $(document).ready(function(){
        var count;
        var countdown;
        var button = $(&apos;#get_verify_code&apos;);
        function Count(){
            count--;
            button.text(&quot;请等待&quot;+count+&quot;秒&quot;);
            if(count == 0){
                clearInterval(countdown);
                button.text(&quot;获取验证码&quot;);
                button.removeAttr(&apos;disabled&apos;);
                localStorage.removeItem(&apos;verify_time&apos;)
            }
        }
        if(localStorage[&apos;verify_time&apos;]){
            var last_time = parseInt(localStorage[&apos;verify_time&apos;]);
            var now_time = parseInt(new Date().getTime());
            if(now_time-last_time &lt; 30000){
                count = parseInt(30-(now_time - last_time)/1000);
                button.text(&quot;请等待&quot;+count+&quot;秒&quot;);
                button.attr(&apos;disabled&apos;, true);
                countdown = setInterval(Count, 1000);
            }
            else{
                localStorage.removeItem(&apos;verify_time&apos;);
            }
        }
        button.click(function(){
            count = 30;
            $(this).text(&quot;请等待&quot;+count+&quot;秒&quot;);
            $(this).attr(&apos;disabled&apos;, true);
            localStorage[&apos;verify_time&apos;] = new Date().getTime();
            countdown = setInterval(Count, 1000);
        })
    });
&lt;/script&gt;
</code></pre><p>首先用  $(ducument).ready(function( ){ })  来实现页面的初始化操作，保证需要的代码操作执行完后，才能对页面进行下一步操作。</p>
<p>这里我们将点击“获取验证码按钮”的时间用时间戳存在localStorage[‘verify_time’] 里，每次计时结束 或者 下一次刷新页面的时候已经距离上次操作30秒后，就将其删除。</p>
<p>每次刷新页面的时候，先判定本地是否记录有上次获取验证码操作的时间，若有，则计算距离上次操作时间是否超过30秒，如果低于30秒，则继续计时；否则，删除本地的记录。</p>
<p>由于 localStorage 都是存的字符串类型，所以在计算时间差和对 count 进行赋值的时候，都要将其转换为int类型。</p>
<p>在这里，我们就能发现重视全局变量带来的好处了，count 和 countdown 虽然都会被函数以及函数的内层调用，但是这些函数都不是在同时对这两个变量进行操作，所以理论上不会引起冲突，故而将 count 和 countdown 定义为全局变量，不仅使得逻辑清楚，还使得代码简洁，减少了很多不必要的操作。</p>
<p>在这之前，我犯过许多错，其中就包括对全局变量的使用不当，也是由于python用惯了，没重视这方面问题，老是喜欢使用局部变量，使得代码逻辑混乱，半天找不出问题。</p>
<p>最后爽性全删掉，重新整理思路，删繁就简，最后才发现，其实完全可以用全局变量，不仅清晰易懂，还减少了很多不必要的操作。</p>


<!-- Comments -->
<div>
    
    <hr />
    <h3>留言:</h3>
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>




</div>



            </div>
        </div>

        <!-- Footer -->
<footer id="footer">
    <div class="inner">
        <section>
            <h2>FriendLinks</h2>
            <div>
                
                        <a href="https://www.rapospectre.com/" target="_blank">RaPoSpectre</a>&nbsp;&nbsp;
                    
                        <a href="https://vkwk.space/" target="_blank">Viking Warlock</a>&nbsp;&nbsp;
                    
                        <a href="http://www.lumiaxu.com/" target="_blank">Lumia Xu</a>&nbsp;&nbsp;
                    
                        <a href="http://djjowfy.com/" target="_blank">djjowfy</a>&nbsp;&nbsp;
                    
                        <a href="http://ziriwong.cc/" target="_blank">ZiriWong</a>&nbsp;&nbsp;
                    
                        <a href="http://toxni.com/" target="_blank">Toxni</a>&nbsp;&nbsp;
                    
                        <a href="https://www.yasicyu.com/" target="_blank">Yasic Yu</a>&nbsp;&nbsp;
                    
                        <a href="http://bigpo.top/" target="_blank">Snowbean</a>&nbsp;&nbsp;
                    
            </div>
        </section>
        <section>
            <h2>Follow</h2>
            <ul class="icons">
                
                
                
                
                
                    <li><a href="https://github.com/ShadowWood" class="icon style2 fa-github" target="_blank" ><span class="label">GitHub</span></a></li>
                
                
                
                
                
                    <li><a href="shadowwood@foxmail.com" class="icon style2 fa-envelope-o" target="_blank" ><span class="label">Email</span></a></li>
                
                
                    <li><a href="/atom.xml" class="icon style2 fa-rss" target="_blank" ><span class="label">RSS</span></a></li>
                
            </ul>
        </section>
        <ul class="copyright">
            <li>&copy; 2016 - 2017 All rights reserved</li>
            <li>Design: <a href="http://html5up.net" target="_blank">HTML5 UP</a></li>
            <li>Shadow Wood</li>
        </ul>
    </div>
</footer>
    </div>

    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- skel -->
<script src="/js/skel.min.js"></script>

<!-- Custom Code -->
<script src="/js/util.js"></script>

<!--[if lte IE 8]>
<script src="/js/ie/respond.min.js"></script>
<![endif]-->

<!-- Custom Code -->
<script src="/js/main.js"></script>

<!-- Gallery -->
<script src="//cdn.rawgit.com/noelboss/featherlight/1.3.5/release/featherlight.min.js" type="text/javascript" charset="utf-8"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/detect_swipe/2.1.1/jquery.detect_swipe.min.js"></script>

<!-- Disqus Comments -->

<script async="true" src="//shadowwood.disqus.com/embed.js">
</script>


</body>

</html>